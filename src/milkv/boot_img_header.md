# RISC-V Linuxのブートイメージヘッダ

[オリジナル](https://www.kernel.org/doc/Documentation/riscv/boot-image-header.rst)

このドキュメントではRISC-V Linuxのブートイメージヘッダーの詳細のみを説明します。

解凍された Linux カーネルイメージには以下の64バイトのヘッダーが存在します。

```c
u32 code0;		  /* Executable code */
u32 code1;		  /* Executable code */
u64 text_offset;	  /* Image load offset, little endian */
u64 image_size;		  /* Effective Image size, little endian */
u64 flags;		  /* kernel flags, little endian */
u32 version;		  /* Version of this header */
u32 res1 = 0;		  /* Reserved */
u64 res2 = 0;		  /* Reserved */
u64 magic = 0x5643534952; /* Magic number, little endian, "RISCV" */
u32 magic2 = 0x05435352;  /* Magic number 2, little endian, "RSC\x05" */
u32 res3;		  /* Reserved for PE COFF offset */
```

このヘッダフォーマットはPE/COFFヘッダに準拠しており、ARM64ヘッダから大きく
インスパイアされています。そのため、将来的にはARM64ヘッダとRISC-Vヘッダを
1つの共通ヘッダにまとめることができるでしょう。

## 注意

- このヘッダはRISC-V用のEFIスタブをサポートするためにも再利用されています。
  EFI仕様ではカーネルイメージをEFIアプリケーションとしてロードするためには
  カーネルイメージの先頭にPE/COFFイメージヘッダが必要です。EFIスタブをサポート
  するためにcode0はマジック文字列"MZ"に置き換えられ、res3(オフセット0x3c)は
  残りのPE/COFFヘッダを指しています。

- version フィールドはヘッダのバージョン番号を示します。

| ビット位置 | 説明 |
|:-----------|:-----|
| 0:15 | マイナーバージョン |
| 16:31 | メジャーバージョン |

  これによりヘッダーの新旧バージョン間の互換性が保たれます。現在のバージョンは
  0.2と定義されています。

- "magic"フィールドはバージョン0.2では非推奨となりました。将来のリリースでは
  削除されるかもしれません。これは本来ARM64ヘッダの"magic"フィールドと一致させる
  べきでしたが残念ながらそうなっていません。"magic2"フィールドはこれに替わるもので
  あり、ARM64ヘッダと一致します。

- 現在のヘッダにはflagsフィールドは1つのフィールドしかありません。

| ビット位置 | 説明 |
|:-----------|:-----|
| 0 | カーネルのエンディアン. 1: BE, 0: LE |

- ブートローダがカーネルイメージをロードするためにイメージサイズは必須です。
  そうでないと起動に失敗します。

## 実例

### `duo-buildroot-sdk/linux_5.10/build/kernel_output/vmlinux`

```bash
00001000: 4d5a 6f10 6007 0100 0000 2000 0000 0000  MZo.`..... .....
00001010: 0000 6900 0000 0000 0000 0000 0000 0000  ..i.............
00001020: 0200 0000 0000 0000 0000 0000 0000 0000  ................
00001030: 5249 5343 5600 0000 5253 4305 4000 0000  RISCV...RSC.@...

u32 code0: 0x4d5a6f10
u32 code1: 0x60070100
u64 text_offset: 0x0000_0000_0020_0000
u64 image_size: 0x0000_0000_0069_0000
u64 flags: 0x0000_0000_0000_0000
u32 version: 0x0000_0002
u32 res1: 0
u64 res2: 0
u64 magic: 0x0000_0056_4353_4952
u32 magic2: 0x0543_5352
u32 res3: 0x0000_0040
```

### xv6カーネル(`xv6-xhack/kernel/kernel`)

```bash
00001000: 81a0 0000 0000 0100 0000 2000 0000 0000  .......... .....
00001010: 0030 1900 0000 0000 0000 0000 0000 0000  .0..............
00001020: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00001030: 5249 5343 5600 0000 5253 4305 0000 0000  RISCV...RSC.....
```
